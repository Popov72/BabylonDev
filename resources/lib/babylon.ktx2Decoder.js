!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define("babylonjs-ktx2-decoder",[],t):"object"==typeof exports?exports["babylonjs-ktx2-decoder"]=t():e.KTX2DECODER=t()}("undefined"!=typeof self?self:"undefined"!=typeof global?global:this,(function(){return function(e){var t={};function n(r){if(t[r])return t[r].exports;var a=t[r]={i:r,l:!1,exports:{}};return e[r].call(a.exports,a,a.exports,n),a.l=!0,a.exports}return n.m=e,n.c=t,n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var a in e)n.d(r,a,function(t){return e[t]}.bind(null,a));return r},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=1)}([function(e,t,n){"use strict";n.d(t,"b",(function(){return g})),n.d(t,"l",(function(){return o})),n.d(t,"c",(function(){return d})),n.d(t,"k",(function(){return r})),n.d(t,"m",(function(){return a})),n.d(t,"h",(function(){return s})),n.d(t,"i",(function(){return c})),n.d(t,"j",(function(){return u})),n.d(t,"a",(function(){return i})),n.d(t,"d",(function(){return h})),n.d(t,"e",(function(){return p})),n.d(t,"f",(function(){return y})),n.d(t,"g",(function(){return m}));var r,a,i=function(){function e(e,t,n){this.littleEndian=!0,e.buffer?this._dataView=new DataView(e.buffer,null!=t?t:e.byteOffset,null!=n?n:e.byteLength):this._dataView=new DataView(e,null!=t?t:0,null!=n?n:e.byteLength),this._dataByteOffset=0}return Object.defineProperty(e.prototype,"byteOffset",{get:function(){return this._dataByteOffset},enumerable:!1,configurable:!0}),e.prototype.readUint8=function(){var e=this._dataView.getUint8(this._dataByteOffset);return this._dataByteOffset+=1,e},e.prototype.readInt8=function(){var e=this._dataView.getInt8(this._dataByteOffset);return this._dataByteOffset+=1,e},e.prototype.readUint16=function(){var e=this._dataView.getUint16(this._dataByteOffset,this.littleEndian);return this._dataByteOffset+=2,e},e.prototype.readInt16=function(){var e=this._dataView.getInt16(this._dataByteOffset,this.littleEndian);return this._dataByteOffset+=2,e},e.prototype.readUint32=function(){var e=this._dataView.getUint32(this._dataByteOffset,this.littleEndian);return this._dataByteOffset+=4,e},e.prototype.readInt32=function(){var e=this._dataView.getInt32(this._dataByteOffset,this.littleEndian);return this._dataByteOffset+=4,e},e.prototype.readUint64=function(){var e=this._dataView.getUint32(this._dataByteOffset,this.littleEndian),t=this._dataView.getUint32(this._dataByteOffset+4,this.littleEndian),n=this.littleEndian?e+Math.pow(2,32)*t:Math.pow(2,32)*e+t;return this._dataByteOffset+=8,n},e.prototype.readUint8Array=function(e){var t=new Uint8Array(this._dataView.buffer,this._dataView.byteOffset+this._dataByteOffset,e);return this._dataByteOffset+=e,t},e.prototype.skipBytes=function(e){return this._dataByteOffset+=e,this},e}();!function(e){e[e.ETC1S=0]="ETC1S",e[e.UASTC4x4=1]="UASTC4x4"}(r||(r={})),function(e){e[e.ASTC_4x4_RGBA=0]="ASTC_4x4_RGBA",e[e.BC7_M5_RGBA=1]="BC7_M5_RGBA",e[e.BC3_RGBA=2]="BC3_RGBA",e[e.BC1_RGB=3]="BC1_RGB",e[e.PVRTC1_4_RGBA=4]="PVRTC1_4_RGBA",e[e.PVRTC1_4_RGB=5]="PVRTC1_4_RGB",e[e.ETC2_RGBA=6]="ETC2_RGBA",e[e.ETC1_RGB=7]="ETC1_RGB",e[e.RGBA32=8]="RGBA32"}(a||(a={}));var o,s=function(){function e(){}return e.CanTranscode=function(e,t){return!1},e.prototype.initialize=function(){},e.prototype.needMemoryManager=function(){return!1},e.prototype.setMemoryManager=function(e){},e.prototype.transcode=function(e,t,n,r,a,i,o,s,d){return Promise.resolve(null)},e}();!function(e){e[e.None=0]="None",e[e.BasisLZ=1]="BasisLZ",e[e.ZStandard=2]="ZStandard",e[e.ZLib=3]="ZLib"}(o||(o={}));var d=function(){function e(e){this._data=e}return Object.defineProperty(e.prototype,"data",{get:function(){return this._data},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"header",{get:function(){return this._header},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"levels",{get:function(){return this._levels},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"dfdBlock",{get:function(){return this._dfdBlock},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"supercompressionGlobalData",{get:function(){return this._supercompressionGlobalData},enumerable:!1,configurable:!0}),e.prototype.isValid=function(){return e.IsValid(this._data)},e.prototype.parse=function(){var e=12,t=new i(this._data,e,68),n=this._header={vkFormat:t.readUint32(),typeSize:t.readUint32(),pixelWidth:t.readUint32(),pixelHeight:t.readUint32(),pixelDepth:t.readUint32(),layerCount:t.readUint32(),faceCount:t.readUint32(),levelCount:t.readUint32(),supercompressionScheme:t.readUint32(),dfdByteOffset:t.readUint32(),dfdByteLength:t.readUint32(),kvdByteOffset:t.readUint32(),kvdByteLength:t.readUint32(),sgdByteOffset:t.readUint64(),sgdByteLength:t.readUint64()};if(n.pixelDepth>0)throw new Error("Failed to parse KTX2 file - Only 2D textures are currently supported.");if(n.layerCount>1)throw new Error("Failed to parse KTX2 file - Array textures are not currently supported.");if(n.faceCount>1)throw new Error("Failed to parse KTX2 file - Cube textures are not currently supported.");e+=t.byteOffset;for(var r=Math.max(1,n.levelCount),a=new i(this._data,e,3*r*8),o=this._levels=[];r--;)o.push({byteOffset:a.readUint64(),byteLength:a.readUint64(),uncompressedByteLength:a.readUint64()});e+=a.byteOffset;var s=new i(this._data,n.dfdByteOffset,n.dfdByteLength),d=this._dfdBlock={vendorId:s.skipBytes(4).readUint16(),descriptorType:s.readUint16(),versionNumber:s.readUint16(),descriptorBlockSize:s.readUint16(),colorModel:s.readUint8(),colorPrimaries:s.readUint8(),transferFunction:s.readUint8(),flags:s.readUint8(),texelBlockDimension:{x:s.readUint8()+1,y:s.readUint8()+1,z:s.readUint8()+1,w:s.readUint8()+1},bytesPlane:[s.readUint8(),s.readUint8(),s.readUint8(),s.readUint8(),s.readUint8(),s.readUint8(),s.readUint8(),s.readUint8()],numSamples:0,samples:new Array};d.numSamples=(d.descriptorBlockSize-24)/16;for(var u=0;u<d.numSamples;u++){var c={bitOffset:s.readUint16(),bitLength:s.readUint8()+1,channelType:s.readUint8(),channelFlags:0,samplePosition:[s.readUint8(),s.readUint8(),s.readUint8(),s.readUint8()],sampleLower:s.readUint32(),sampleUpper:s.readUint32()};c.channelFlags=(240&c.channelType)>>4,c.channelType=15&c.channelType,d.samples.push(c)}var f=this._supercompressionGlobalData={};if(n.sgdByteLength>0){var l=new i(this._data,n.sgdByteOffset,n.sgdByteLength);f.endpointCount=l.readUint16(),f.selectorCount=l.readUint16(),f.endpointsByteLength=l.readUint32(),f.selectorsByteLength=l.readUint32(),f.tablesByteLength=l.readUint32(),f.extendedByteLength=l.readUint32(),f.imageDescs=[];var h=this._getImageCount();for(u=0;u<h;u++)f.imageDescs.push({imageFlags:l.readUint32(),rgbSliceByteOffset:l.readUint32(),rgbSliceByteLength:l.readUint32(),alphaSliceByteOffset:l.readUint32(),alphaSliceByteLength:l.readUint32()});var p=n.sgdByteOffset+l.byteOffset,y=p+f.endpointsByteLength,m=y+f.selectorsByteLength,_=m+f.tablesByteLength;f.endpointsData=new Uint8Array(this._data.buffer,p,f.endpointsByteLength),f.selectorsData=new Uint8Array(this._data.buffer,y,f.selectorsByteLength),f.tablesData=new Uint8Array(this._data.buffer,m,f.tablesByteLength),f.extendedData=new Uint8Array(this._data.buffer,_,f.extendedByteLength)}},e.prototype._getImageCount=function(){for(var e=Math.max(this._header.pixelDepth,1),t=1;t<this._header.levelCount;t++)e+=Math.max(this._header.pixelDepth>>t,1);return Math.max(this._header.layerCount,1)*this._header.faceCount*e},Object.defineProperty(e.prototype,"textureFormat",{get:function(){return 166===this._dfdBlock.colorModel?r.UASTC4x4:r.ETC1S},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"hasAlpha",{get:function(){switch(this.textureFormat){case r.ETC1S:return 2===this._dfdBlock.numSamples&&(15===this._dfdBlock.samples[0].channelType||15===this._dfdBlock.samples[1].channelType);case r.UASTC4x4:return 3===this._dfdBlock.samples[0].channelType}return!1},enumerable:!1,configurable:!0}),e.prototype.getHasAlpha=function(){switch(this.textureFormat){case r.ETC1S:return 2===this._dfdBlock.numSamples&&(15===this._dfdBlock.samples[0].channelType||15===this._dfdBlock.samples[1].channelType);case r.UASTC4x4:return 3===this._dfdBlock.samples[0].channelType}return!1},e.IsValid=function(e){if(e.byteLength>=12){var t=new Uint8Array(e.buffer,e.byteOffset,12);if(171===t[0]&&75===t[1]&&84===t[2]&&88===t[3]&&32===t[4]&&50===t[5]&&48===t[6]&&187===t[7]&&13===t[8]&&10===t[9]&&26===t[10]&&10===t[11])return!0}return!1},e}(),u=function(){function e(t){void 0===t&&(t=e.InitialMemoryPages),this._numPages=t,this._memory=new WebAssembly.Memory({initial:this._numPages}),this._memoryViewByteLength=this._numPages<<16,this._memoryViewOffset=0,this._memoryView=new Uint8Array(this._memory.buffer,this._memoryViewOffset,this._memoryViewByteLength)}return e.LoadWASM=function(e){if(!this.LoadBinariesFromMainThread)return new Promise((function(t){fetch(e).then((function(e){return e.arrayBuffer()})).then((function(e){return t(e)}))}));var t=this._RequestId++;return new Promise((function(n){var r=function(e){"wasmLoaded"===e.data.action&&e.data.id===t&&(self.removeEventListener("message",r),n(e.data.wasmBinary))};self.addEventListener("message",r),postMessage({action:"loadWASM",path:e,id:t})}))},Object.defineProperty(e.prototype,"wasmMemory",{get:function(){return this._memory},enumerable:!1,configurable:!0}),e.prototype.getMemoryView=function(e,t,n){return void 0===t&&(t=0),n=null!=n?n:e<<16,this._numPages<e?(this._memory.grow(e-this._numPages),this._numPages=e,this._memoryView=new Uint8Array(this._memory.buffer,t,n),this._memoryViewByteLength=n,this._memoryViewOffset=t):(this._memoryView=new Uint8Array(this._memory.buffer,t,n),this._memoryViewByteLength=n,this._memoryViewOffset=t),this._memoryView},e.LoadBinariesFromMainThread=!1,e.InitialMemoryPages=16,e._RequestId=0,e}(),c=function(){function e(){}return e.registerTranscoder=function(t){e._Transcoders.push(t)},e.prototype.findTranscoder=function(t,n){for(var i=null,o=0;o<e._Transcoders.length;++o)if(e._Transcoders[o].CanTranscode(t,n)){var s=r[t]+"_"+a[n];(i=e._transcoderInstances[s])||((i=new e._Transcoders[o]).initialize(),i.needMemoryManager()&&(this._wasmMemoryManager||(this._wasmMemoryManager=new u),i.setMemoryManager(this._wasmMemoryManager)),e._transcoderInstances[s]=i);break}return i},e._Transcoders=[],e._transcoderInstances={},e}(),f=function(e,t){return(f=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(e,t)};function l(e,t){function n(){this.constructor=e}f(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}Object.create;Object.create;var h=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return l(t,e),t.prototype._loadModule=function(){var e=this;return this._modulePromise||(this._modulePromise=new Promise((function(t){u.LoadWASM(e._modulePath).then((function(n){WebAssembly.instantiate(n,{env:{memory:e._memoryManager.wasmMemory}}).then((function(e){t({module:e.instance.exports})}))}))}))),this._modulePromise},Object.defineProperty(t.prototype,"memoryManager",{get:function(){return this._memoryManager},enumerable:!1,configurable:!0}),t.prototype.setModulePath=function(e){this._modulePath=e},t.prototype.needMemoryManager=function(){return!0},t.prototype.setMemoryManager=function(e){this._memoryManager=e},t.prototype.transcode=function(e,t,n,r,a,i,o,s,d){var u=this;return this._loadModule().then((function(e){var t=e.module,n=(r+3>>2)*(a+3>>2),i=1+(16*n+65535>>16),o=u.memoryManager.getMemoryView(i,65536,16*n);return o.set(d),0===t.transcode(n)?o.slice():null}))},t}(s),p=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return l(t,e),t.CanTranscode=function(e,t){return e===r.UASTC4x4&&t===a.ASTC_4x4_RGBA},t.prototype.initialize=function(){this.setModulePath(t.WasmModuleURL)},t.WasmModuleURL="https://preview.babylonjs.com/ktx2Transcoders/uastc_astc.wasm",t}(h),y=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return l(t,e),t.CanTranscode=function(e,t){return e===r.UASTC4x4&&t===a.BC7_M5_RGBA},t.prototype.initialize=function(){this.setModulePath(t.WasmModuleURL)},t.WasmModuleURL="https://preview.babylonjs.com/ktx2Transcoders/uastc_bc7.wasm",t}(h),m=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return l(t,e),t.prototype._getMSCBasisTranscoder=function(){var e=this;return this._mscBasisTranscoderPromise||(this._mscBasisTranscoderPromise=new Promise((function(n){t.UseFromWorkerThread&&importScripts(t.JSModuleURL),u.LoadWASM(t.WasmModuleURL).then((function(t){MSC_TRANSCODER({wasmBinary:t}).then((function(t){t.initTranscoders(),e._mscBasisModule=t,n()}))}))}))),this._mscBasisTranscoderPromise},t.CanTranscode=function(e,t){return!0},t.prototype.transcode=function(e,t,n,i,o,s,d,u,c){var f=this;return this._getMSCBasisTranscoder().then((function(){var l,h=f._mscBasisModule,p=h.TranscodeTarget,y=h.TextureFormat,m=h.ImageInfo,_=e===r.UASTC4x4?new h.UastcImageTranscoder:new h.BasisLzEtc1sImageTranscoder,g=e===r.UASTC4x4?y.UASTC4x4:y.ETC1S,B=new m(g,i,o,n),b=p[a[t]];if(!h.isFormatSupported(b,g))throw new Error('MSCTranscoder: Transcoding from "'+r[e]+'" to "'+a[t]+'" not supported by current transcoder build.');if(e===r.ETC1S){var w=d.supercompressionGlobalData;_.decodePalettes(w.endpointCount,w.endpointsData,w.selectorCount,w.selectorsData),_.decodeTables(w.tablesData),B.flags=u.imageFlags,B.rgbByteOffset=0,B.rgbByteLength=u.rgbSliceByteLength,B.alphaByteOffset=u.alphaSliceByteOffset>0?u.rgbSliceByteLength:0,B.alphaByteLength=u.alphaSliceByteLength,l=_.transcodeImage(b,c,B,0,!1)}else B.flags=0,B.rgbByteOffset=0,B.rgbByteLength=s,B.alphaByteOffset=0,B.alphaByteLength=0,l=_.transcodeImage(b,c,B,0,d.hasAlpha,!1);if(l&&void 0!==l.transcodedImage){var T=l.transcodedImage.get_typed_memory_view().slice();return l.transcodedImage.delete(),T}return null}))},t.JSModuleURL="https://preview.babylonjs.com/ktx2Transcoders/msc_basis_transcoder.js",t.WasmModuleURL="https://preview.babylonjs.com/ktx2Transcoders/msc_basis_transcoder.wasm",t.UseFromWorkerThread=!0,t}(s),_=function(e){return 0==(e&e-1)&&0!==e},g=function(){function e(){this._transcoderMgr=new c}return e.prototype.decode=function(e,t){var n=new d(e);if(!n.isValid)return null;n.parse();var i=n.header.pixelWidth,s=n.header.pixelHeight,u=n.textureFormat,c=_(i)&&_(s),f=-1,l=-1;t.astc?(f=a.ASTC_4x4_RGBA,l=37808):t.bptc&&u===r.UASTC4x4?(f=a.BC7_M5_RGBA,l=36492):t.s3tc?(f=n.hasAlpha?a.BC3_RGBA:a.BC1_RGB,l=n.hasAlpha?33779:33776):t.pvrtc&&c?(f=n.hasAlpha?a.PVRTC1_4_RGBA:a.PVRTC1_4_RGB,l=n.hasAlpha?35842:35840):t.etc2?(f=n.hasAlpha?a.ETC2_RGBA:a.ETC1_RGB,l=n.hasAlpha?37496:37492):t.etc1?(f=a.ETC1_RGB,l=36196):(f=a.RGBA32,l=32856);var h=this._transcoderMgr.findTranscoder(u,f);if(null===h)throw new Error('no transcoder found to transcode source texture format "'+r[u]+'" to format "'+a[f]+'"');for(var p=[],y=[],m=[],g={width:0,height:0,transcodedFormat:l,mipmaps:p},B=0,b=0;b<n.header.levelCount;b++){b>0&&(B+=Math.max(n.header.layerCount,1)*n.header.faceCount*Math.max(n.header.pixelDepth>>b-1,1));var w=i/Math.pow(2,b),T=s/Math.pow(2,b),U=n.header.faceCount,v=(w+3>>2)*(T+3>>2)*n.dfdBlock.bytesPlane[0],M=n.levels[b].uncompressedByteLength,C=n.data.buffer,O=n.levels[b].byteOffset,S=0;if(n.header.supercompressionScheme===o.ZStandard)throw new Error("ZStandard supercompression scheme is not supported yet");0===b&&(g.width=w,g.height=T);for(var A=function(e){var t=void 0,r=null;n.header.supercompressionScheme===o.BasisLZ?(r=n.supercompressionGlobalData.imageDescs[B+e],t=new Uint8Array(C,O+r.rgbSliceByteOffset,r.rgbSliceByteLength+r.alphaSliceByteLength)):(t=new Uint8Array(C,O+S,v),S+=v);var a={data:null,width:w,height:T},i=h.transcode(u,f,b,w,T,M,n,r,t).then((function(e){return a.data=e,e&&m.push(e.buffer),e}));p.push(a),y.push(i)},L=0;L<U;L++)A(L)}return Promise.all(y).then((function(){return g}))},e}();c.registerTranscoder(p),c.registerTranscoder(y),c.registerTranscoder(m)},function(e,t,n){"use strict";n.r(t),function(e){var r=n(0);n.d(t,"KTX2Decoder",(function(){return r.b})),n.d(t,"supercompressionScheme",(function(){return r.l})),n.d(t,"KTX2FileReader",(function(){return r.c})),n.d(t,"sourceTextureFormat",(function(){return r.k})),n.d(t,"transcodeTarget",(function(){return r.m})),n.d(t,"Transcoder",(function(){return r.h})),n.d(t,"TranscoderManager",(function(){return r.i})),n.d(t,"WASMMemoryManager",(function(){return r.j})),n.d(t,"DataReader",(function(){return r.a})),n.d(t,"LiteTranscoder",(function(){return r.d})),n.d(t,"LiteTranscoder_UASTC_ASTC",(function(){return r.e})),n.d(t,"LiteTranscoder_UASTC_BC7",(function(){return r.f})),n.d(t,"MSCTranscoder",(function(){return r.g}));var a=void 0!==e?e:"undefined"!=typeof window?window:void 0;void 0!==a&&(a.KTX2DECODER=r.b)}.call(this,n(2))},function(e,t){var n;n=function(){return this}();try{n=n||new Function("return this")()}catch(e){"object"==typeof window&&(n=window)}e.exports=n}])}));